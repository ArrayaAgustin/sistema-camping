generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =========================
// PERSONAS (IDENTIDAD ÚNICA)
// =========================
model personas {
  id               Int       @id @default(autoincrement())
  dni              String    @unique(map: "uq_personas_dni") @db.VarChar(8)
  apellido         String?   @db.VarChar(100)
  nombres          String?   @db.VarChar(100)
  nombre_completo  String?   @db.VarChar(200)
  sexo             sexo_enum?
  fecha_nacimiento DateTime? @db.Date
  email            String?   @db.VarChar(100)
  telefono         String?   @db.VarChar(50)
  qr_code          String    @unique(map: "uq_personas_qr") @db.VarChar(64)
  created_at       DateTime? @default(now()) @db.Timestamp(0)
  updated_at       DateTime? @default(now()) @updatedAt @db.Timestamp(0)
  
  Usuario usuarios?
  Afiliado     afiliados?
  Familiares   familiares[]
  Invitaciones invitados[]
  Visitas      visitas[]

  @@index([apellido], map: "idx_personas_apellido")
  @@index([dni], map: "idx_personas_dni")
  @@map("personas")
}

// =========================
// INVITADOS (PERMISOS)
// =========================
model invitados {
  id               Int       @id @default(autoincrement())
  persona_id       Int
  vigente_desde    DateTime? @db.Date
  vigente_hasta    DateTime? @db.Date
  aplica_a_familia Boolean?  @default(true)
  activo           Boolean?  @default(true)
  created_at       DateTime? @default(now()) @db.Timestamp(0)
  updated_at       DateTime? @default(now()) @updatedAt @db.Timestamp(0)

  Persona personas @relation(fields: [persona_id], references: [id], onDelete: Cascade)

  @@index([activo], map: "idx_invitados_activo")
  @@index([persona_id], map: "idx_invitados_persona")
  @@index([vigente_hasta], map: "idx_invitados_vigencia")
  @@map("invitados")
}

// =========================
// AFILIADOS (PADRÓN)
// =========================
model afiliados {
  id                    Int                         @id @default(autoincrement()) @map("id")
 persona_id Int? @unique(map: "uq_afiliados_persona")
  cuil                  String                      @unique(map: "cuil") @db.VarChar(11)
  sexo                  sexo_enum
  tipo_afiliado         String?                     @db.VarChar(50)
  fecha_nacimiento      DateTime?                   @db.Date
  categoria             String?                     @db.VarChar(100)
  situacion_sindicato   situacion_sindicato_enum?   @default(ACTIVO)
  situacion_obra_social situacion_obra_social_enum? @default(ACTIVO)
  domicilio             String?                     @db.VarChar(255)
  provincia             String?                     @db.VarChar(100)
  localidad             String?                     @db.VarChar(100)
  empresa_cuit          String?                     @db.VarChar(11)
  empresa_nombre        String?                     @db.VarChar(200)
  codigo_postal         String?                     @db.VarChar(10)
  grupo_sanguineo       String?                     @db.VarChar(5)
  foto_url              String?                     @db.VarChar(255)
  padron_version_id     Int?
  activo                Boolean?                    @default(true)
  created_at            DateTime?                   @default(now()) @db.Timestamp(0)
  updated_at            DateTime?                   @default(now()) @updatedAt @db.Timestamp(0)

  Persona       personas?         @relation(fields: [persona_id], references: [id], onDelete: SetNull)
  PadronVersion padron_versiones? @relation(fields: [padron_version_id], references: [id])
  Familiares    familiares[]      @relation("titular")
  Usuarios      usuarios[]        @relation("afiliado_usuario")
  Visitas       visitas[]         @relation("afiliado_visita")

  @@index([activo], map: "idx_activo")
  @@index([cuil], map: "idx_cuil")
  @@index([empresa_cuit], map: "idx_empresa_cuit")
  @@index([padron_version_id], map: "idx_padron_version")
  @@index([persona_id], map: "idx_persona_id")
  @@index([situacion_sindicato], map: "idx_situacion_sindicato")
  @@map("afiliados")
}

// =========================
// FAMILIARES
// =========================
model familiares {
  id            Int       @id @default(autoincrement())
  persona_id    Int?
  afiliado_id   Int
  estudia       Boolean?  @default(false)
  discapacitado Boolean?  @default(false)
  baja          Boolean?  @default(false)
  activo        Boolean?  @default(true)
  created_at    DateTime? @default(now()) @db.Timestamp(0)
  updated_at    DateTime? @default(now()) @updatedAt @db.Timestamp(0)

  Persona  personas? @relation(fields: [persona_id], references: [id], onDelete: SetNull)
  Afiliado afiliados @relation("titular", fields: [afiliado_id], references: [id], onDelete: Cascade)

  @@index([afiliado_id, activo], map: "idx_afiliado_activo")
  @@index([afiliado_id], map: "idx_afiliado_id")
  @@index([persona_id], map: "idx_familiares_persona")
  @@index([baja], map: "idx_baja")
  @@map("familiares")
}

// =========================
// USUARIOS
// =========================
model usuarios {
  id                 Int                @id @default(autoincrement())
  username           String             @unique(map: "username") @db.VarChar(50)
  password_hash      String             @db.VarChar(255)
  email              String?            @db.VarChar(100)
  afiliado_id        Int?  
  persona_id         Int?               @unique 
  must_change_password Boolean?         @default(false)
  activo             Boolean?           @default(true)
  ultimo_acceso      DateTime?          @db.Timestamp(0)
  created_at         DateTime?          @default(now()) @db.Timestamp(0)
  updated_at         DateTime?          @default(now()) @updatedAt @db.Timestamp(0)

  AuditoriaPadron    auditoria_padron[]
  PeriodosApertura   periodos_caja[] @relation("usuario_apertura")
  PeriodosCierre     periodos_caja[] @relation("usuario_cierre")
  SyncLogs           sync_logs[]
  UsuarioRoles       usuario_roles[]
  Afiliado           afiliados? @relation("afiliado_usuario", fields: [afiliado_id], references: [id])
  Persona  personas?  @relation(fields: [persona_id], references: [id])
  VisitasRegistradas visitas[] @relation("usuario_registro")

  @@index([activo], map: "idx_activo")
  @@index([afiliado_id], map: "idx_afiliado")
  @@index([username], map: "idx_username")
  @@map("usuarios")
}

// =========================
// ROLES
// =========================
model roles {
  id           Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.Text
  permisos     Json?
  created_at   DateTime? @default(now()) @db.Timestamp(0)

  UsuarioRoles usuario_roles[]

  @@map("roles")
}

model usuario_roles {
  id               Int       @id @default(autoincrement())
  usuario_id       Int
  rol_id           Int
  camping_id       Int?
  activo           Boolean?  @default(true)
  fecha_asignacion DateTime? @default(now()) @db.Timestamp(0)

  Usuario usuarios @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  Role    roles    @relation(fields: [rol_id], references: [id], onDelete: Cascade)
  Camping campings? @relation(fields: [camping_id], references: [id])

  @@unique([usuario_id, rol_id, camping_id], map: "unique_usuario_rol_camping")
  @@map("usuario_roles")
}

// =========================
// PADRÓN VERSIONES
// =========================
model padron_versiones {
  id                  Int       @id @default(autoincrement())
  version             String    @unique(map: "version") @db.VarChar(50)
  fecha_actualizacion DateTime  @db.Timestamp(0)
  total_afiliados     Int?      @default(0)
  total_familiares    Int?      @default(0)
  descripcion         String?   @db.Text
  hash_checksum       String?   @db.VarChar(64)
  usuario_carga_id    Int?
  activo              Boolean?  @default(true)
  created_at          DateTime? @default(now()) @db.Timestamp(0)

  Afiliados afiliados[]

  @@map("padron_versiones")
}

// =========================
// CAMPINGS
// =========================
model campings {
  id           Int       @id @default(autoincrement())
  nombre       String    @db.VarChar(200)
  descripcion  String?   @db.Text
  ubicacion    String?   @db.VarChar(255)
  provincia    String?   @db.VarChar(100)
  localidad    String?   @db.VarChar(100)
  telefono     String?   @db.VarChar(50)
  email        String?   @db.VarChar(100)
  latitud      Decimal?  @db.Decimal(10, 7)
  longitud     Decimal?  @db.Decimal(10, 7)
  foto_url     String?   @db.Text
  activo       Boolean?  @default(true)
  created_at   DateTime? @default(now()) @db.Timestamp(0)
  updated_at   DateTime? @default(now()) @updatedAt @db.Timestamp(0)

  PeriodosCaja periodos_caja[] @relation("camping_periodo")
  SyncLogs     sync_logs[]
  UsuarioRoles usuario_roles[]
  Visitas      visitas[] @relation("camping_visita")

  @@map("campings")
}

// =========================
// VISITAS
// =========================
model visitas {
  id                  Int       @id @default(autoincrement())
  uuid                String    @unique(map: "uuid") @db.VarChar(36)
  persona_id          Int?
  afiliado_id         Int?
  camping_id          Int
  periodo_caja_id     Int?
  usuario_registro_id Int

  condicion_ingreso condicion_ingreso_enum? @default(DESCONOCIDO)

  fecha_ingreso    DateTime? @default(now()) @db.Timestamp(0)
  fecha_egreso     DateTime? @db.Timestamp(0)
  acompanantes     Json?
  observaciones    String?  @db.Text
  sincronizado     Boolean? @default(true)
  registro_offline Boolean? @default(false)
  created_at       DateTime? @default(now()) @db.Timestamp(0)
  updated_at       DateTime? @default(now()) @updatedAt @db.Timestamp(0)

  Persona     personas?      @relation(fields: [persona_id], references: [id])
  Afiliado    afiliados?     @relation("afiliado_visita", fields: [afiliado_id], references: [id])
  Camping     campings       @relation("camping_visita", fields: [camping_id], references: [id])
  PeriodoCaja periodos_caja? @relation(fields: [periodo_caja_id], references: [id])
  UsuarioReg  usuarios       @relation("usuario_registro", fields: [usuario_registro_id], references: [id])

  @@map("visitas")
}

// =========================
// PERIODOS CAJA
// =========================
model periodos_caja {
  id                  Int       @id @default(autoincrement())
  camping_id          Int
  usuario_apertura_id Int
  usuario_cierre_id   Int?
  fecha_apertura      DateTime? @default(now()) @db.Timestamp(0)
  fecha_cierre        DateTime? @db.Timestamp(0)
  total_visitas       Int?      @default(0)
  observaciones       String?   @db.Text
  sincronizado        Boolean?  @default(true)
  activo              Boolean?  @default(true)

  Camping         campings @relation("camping_periodo", fields: [camping_id], references: [id])
  UsuarioApertura usuarios @relation("usuario_apertura", fields: [usuario_apertura_id], references: [id])
  UsuarioCierre   usuarios? @relation("usuario_cierre", fields: [usuario_cierre_id], references: [id])
  Visitas         visitas[]

  @@map("periodos_caja")
}

// =========================
// SYNC LOGS
// =========================
model sync_logs {
  id                      Int       @id @default(autoincrement())
  usuario_id              Int
  camping_id              Int?
  tipo                    sync_tipo_enum
  registros_sincronizados Int?      @default(0)
  fecha_sync              DateTime? @default(now()) @db.Timestamp(0)
  estado                  sync_estado_enum? @default(success)
  errores                 Json?
  detalles                Json?

  Usuario usuarios @relation(fields: [usuario_id], references: [id])
  Camping campings? @relation(fields: [camping_id], references: [id])

  @@map("sync_logs")
}

// =========================
// AUDITORÍA
// =========================
model auditoria_padron {
  id               Int       @id @default(autoincrement())
  usuario_id       Int
  accion           auditoria_accion_enum
  tabla            String    @db.VarChar(50)
  registro_id      Int
  datos_anteriores Json?
  datos_nuevos     Json?
  ip_address       String?   @db.VarChar(45)
  created_at       DateTime? @default(now()) @db.Timestamp(0)

  Usuario usuarios @relation(fields: [usuario_id], references: [id])

  @@map("auditoria_padron")
}

// =========================
// CONFIG
// =========================
model configuracion_sistema {
  id          Int       @id @default(autoincrement())
  clave       String    @unique(map: "clave") @db.VarChar(100)
  valor       String?   @db.Text
  tipo        config_tipo_enum? @default(string)
  descripcion String?   @db.Text
  updated_at  DateTime? @default(now()) @updatedAt @db.Timestamp(0)

  @@map("configuracion_sistema")
}

// =========================
// ENUMS
// =========================
enum sexo_enum {
  M
  F
  X
}

enum situacion_sindicato_enum {
  ACTIVO
  BAJA
}

enum situacion_obra_social_enum {
  ACTIVO
  BAJA
}

enum sync_tipo_enum {
  visita
  egreso
  cierre_caja
  batch
  padron
}

enum sync_estado_enum {
  success
  partial
  failed
}

enum auditoria_accion_enum {
  INSERT
  UPDATE
  DELETE
  IMPORT
}

enum config_tipo_enum {
  string
  number
  boolean
  json
}

enum condicion_ingreso_enum {
  AFILIADO
  FAMILIAR
  INVITADO
  DESCONOCIDO
}
